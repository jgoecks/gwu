<tool id="checkaltmapping" name="Check alternative mappings">
  <description> of reads that map to locations other than expected</description>
  <command interpreter="perl">
    checkAltMapping.pl $fastq $sam $prim $bed $gen $out $pct
    #if str($log_opt) == "true":
      $log
    #end if
  </command>
  <inputs>
    <param format="fastq" name="fastq" type="data" label="Reads that have been mapped" help="Must have removed-primer information in the header, of the format produced by the tool &quot;Remove PCR primers&quot;. Other than primer removal, no other truncations of the reads should have occurred (e.g. quality-based trimming)."/>
    <param format="sam" name="sam" type="data" label="Mapping file" help="Should be unsorted; each read's mapping(s) (primary and secondary) should be listed consecutively. No supplementary alignments are allowed. Soft-clipping (local alignments) should be avoided as well."/>
    <param format="csv" name="prim" type="data" label="File listing primer and target sequences" help="See &quot;Primer and target file&quot; section below for format."/>
    <param format="bed" name="bed" type="data" label="File listing primer locations"/>
    <param format="fasta" name="gen" type="select" label="Reference genome">
      <options from_data_table="all_fasta"/>
    </param>
    <param name="pct" type="float" value="0.75" min="0" max="1" label="Primer match score threshhold (0-1)" help="Primer scores of at least this value will be considered a match. See &quot;Primer matching score&quot; below for more information."/>
    <param name="log_opt" type="boolean" truevalue="true" falsevalue="false" checked="false" label="Check if you would like a verbose output log file" help="By default, one output file (listing mapping judgments) is produced."/>
  </inputs>
  <outputs>
    <data format="tabular" name="out" label="${tool.name} on ${on_string}: mapping judgments"/>
    <data format="tabular" name="log" label="${tool.name} on ${on_string}: alignments log file">
      <filter>log_opt is True</filter>
    </data>
  </outputs>

  <help>
This tool checks reads that map to alternative locations and judges whether
the mappings are likely legitimate or not. This is used to help resolve the
correct origin of multi-mapping reads. For example, consider a read (whose
primers have been removed) that maps equally as well to an alternative site as
to the expected location. If it is determined that the PCR primers would not
have bound at the alternative site, that mapping can be ruled out, leaving the
expected mapping as the correct one.

This tool analyzes every read mapping (either primary or secondary) that is
not to the expected location. It compares the regions corresponding to where
the primers would have bound at that alternative site to the actual primer
sequences (see *Primer matching score* below).

The output file lists the amplicon, the alternative mapping location, and
the match judgment (1 if the primer score is above the specified threshhold,
else 0; if both primers were removed from the read, both must score above
the threshhold to be considered a match). The tool *Edit a SAM file* uses
this output to edit the mapping file.

The optional output alignments log file lists the alignments and scores that
were used to make the match judgments.

-----

**Primer matching score**

To evaluate whether a primer is likely to bind to a given DNA segment, the
following weighted scoring function was developed. The last 20 bases of the
primer are numbered 1-20, with #20 at the 3' end. Each base is valued
according to its position::

  Position   Value
    1-10     2*pos
   11-19     3*pos
     20      5*pos
   other       1

The values of the matches between the primer and the DNA segment are summed
and divided by the sum of the values of all positions. This gives the
score, on a scale of 0-1, with 1 representing a perfect match.

Primers shorter than 20bp are numbered to leave off the lower positions
(e.g. an 18bp primer is numbered 3-20). Primers longer than 20bp have all
positions upstream of the last 20bp valued at 1.

For example::

  primer  ACGTACGTACGTACGTACGTACG
  genome  TGGTACTTAGGGACGCACGTGCG
            **** ** * *** **** **

The score of this primer match is 483 / 618 = 0.782.

-----

**Primer and target file**

This input file should list, on each line, an amplicon name, followed by the
sequences of the forward primer, the reverse primer, and the target region,
comma-delimited. All sequences should be given with respect to the plus
strand.

The file produced by the tool *Retrieve primers and target sequences* follows
this format.

  </help>

</tool>
